import { useCallback, useContext, useEffect, useRef, useState } from "react";
import { useNavigate } from "react-router-dom";
import { sessionContext } from "../../../app";
import flareLogo from "../../../assets/Flare_Logo_Color.png";
import qbLogo from "../../../assets/QuickBooks_Logo_Color.png";
import organizationService from "../../../services/organizationService";
import QuickbooksAuthService from "../../../services/quickbooksAuthService";

const quickbooksAuthService = new QuickbooksAuthService();
let windowObjectReference: Window | null = null;
let previousUrl: string = "";

export function QuickbooksAuthCard() {
	const navigate = useNavigate();
	const session = useContext(sessionContext);
	const messagesReceived = useRef(0);

	let [authenticating, setAuthenticating] = useState(false);

	useEffect(() => {
		return () => {
			window.removeEventListener("message", receiveMessage);
		};
	}, []);

	const handleClick = async () => {
		setAuthenticating(true);
		// user clicks button
		// call api for auth url
		const { authUri } = await quickbooksAuthService.getQuickbooksAuthUrl();
		console.log("Quickbooks Auth URL", authUri);

		// open new window with url
		openSignInWindow(authUri, "Authorize Flare to Use Your Quickbooks");

		// on failure
		// close window and give failure message (or navigate to failure page?)
		// on success
		// send to opener window realmId (ais_customer_id), access token, and refresh token
		// close the window
		// store the data in the org database
		// navigate to user dashboard
	};

	const receiveMessage = useCallback(async (event: MessageEvent<any>) => {
		if (event.data.type !== "token-url") return;

		messagesReceived.current += 1;
		console.log("MESSAGES RECEIVED", messagesReceived.current);
		console.log("Event", event);
		const { url } = event.data;
		console.log("Redirect URL", url);
		const tokens = await quickbooksAuthService.getQuickbooksTokens(url);
		console.log("Tokens", tokens);
		organizationService.updateOrg({
			id: session?.organization?.id,
			aisSystem: "QuickBooks",
			aisOrganizationId: tokens.token.realmId,
			aisToken: tokens.json,
		});
		console.log("Refreshing Session");
		await session?.updateSession();
		navigate("/", { replace: true });
		setAuthenticating(false);
	}, []);

	const openSignInWindow = (url: string, name: string) => {
		window.removeEventListener("message", receiveMessage);

		const strWindowFeatures =
			"toolbar=no, menubar=no, width=600, height=700, top=100, left=100";

		if (windowObjectReference === null || windowObjectReference.closed) {
			windowObjectReference = window.open(url, name, strWindowFeatures);
		} else if (previousUrl !== url) {
			windowObjectReference = window.open(url, name, strWindowFeatures);
			windowObjectReference?.focus();
		} else {
			windowObjectReference.focus();
		}

		window.addEventListener("message", receiveMessage, false);
		previousUrl = url;
	};

	return (
		<div className="w-3/4 mx-auto">
			<div className="flex flex-col pt-14 bg-white rounded-md shadow">
				<div className="flex mx-auto mb-8 gap-5">
					<img
						id="qb-logo"
						style={{ width: "62px", height: "62px" }}
						src={qbLogo}
						alt="qb-logo"
					/>
					<div className="flex flex-col justify-center text-center">
						<svg
							width="60"
							height="25"
							viewBox="0 0 60 25"
							fill="none"
							xmlns="http://www.w3.org/2000/svg"
						>
							<path
								d="M1 3.5C0.723858 3.5 0.5 3.72386 0.5 4C0.5 4.27614 0.723858 4.5 1 4.5V3.5ZM59.3536 4.35355C59.5488 4.15829 59.5488 3.84171 59.3536 3.64645L56.1716 0.464466C55.9763 0.269204 55.6597 0.269204 55.4645 0.464466C55.2692 0.659728 55.2692 0.976311 55.4645 1.17157L58.2929 4L55.4645 6.82843C55.2692 7.02369 55.2692 7.34027 55.4645 7.53553C55.6597 7.7308 55.9763 7.7308 56.1716 7.53553L59.3536 4.35355ZM1.50877 4.5C1.78491 4.5 2.00877 4.27614 2.00877 4C2.00877 3.72386 1.78491 3.5 1.50877 3.5V4.5ZM3.54386 3.5C3.26772 3.5 3.04386 3.72386 3.04386 4C3.04386 4.27614 3.26772 4.5 3.54386 4.5V3.5ZM4.5614 4.5C4.83755 4.5 5.0614 4.27614 5.0614 4C5.0614 3.72386 4.83755 3.5 4.5614 3.5V4.5ZM6.59649 3.5C6.32035 3.5 6.09649 3.72386 6.09649 4C6.09649 4.27614 6.32035 4.5 6.59649 4.5V3.5ZM7.61404 4.5C7.89018 4.5 8.11404 4.27614 8.11404 4C8.11404 3.72386 7.89018 3.5 7.61404 3.5V4.5ZM9.64912 3.5C9.37298 3.5 9.14912 3.72386 9.14912 4C9.14912 4.27614 9.37298 4.5 9.64912 4.5V3.5ZM10.6667 4.5C10.9428 4.5 11.1667 4.27614 11.1667 4C11.1667 3.72386 10.9428 3.5 10.6667 3.5V4.5ZM12.7018 3.5C12.4256 3.5 12.2018 3.72386 12.2018 4C12.2018 4.27614 12.4256 4.5 12.7018 4.5V3.5ZM13.7193 4.5C13.9954 4.5 14.2193 4.27614 14.2193 4C14.2193 3.72386 13.9954 3.5 13.7193 3.5V4.5ZM15.7544 3.5C15.4782 3.5 15.2544 3.72386 15.2544 4C15.2544 4.27614 15.4782 4.5 15.7544 4.5V3.5ZM16.7719 4.5C17.0481 4.5 17.2719 4.27614 17.2719 4C17.2719 3.72386 17.0481 3.5 16.7719 3.5V4.5ZM18.807 3.5C18.5309 3.5 18.307 3.72386 18.307 4C18.307 4.27614 18.5309 4.5 18.807 4.5V3.5ZM19.8246 4.5C20.1007 4.5 20.3246 4.27614 20.3246 4C20.3246 3.72386 20.1007 3.5 19.8246 3.5V4.5ZM21.8596 3.5C21.5835 3.5 21.3596 3.72386 21.3596 4C21.3596 4.27614 21.5835 4.5 21.8596 4.5V3.5ZM22.8772 4.5C23.1533 4.5 23.3772 4.27614 23.3772 4C23.3772 3.72386 23.1533 3.5 22.8772 3.5V4.5ZM24.9123 3.5C24.6361 3.5 24.4123 3.72386 24.4123 4C24.4123 4.27614 24.6361 4.5 24.9123 4.5V3.5ZM25.9298 4.5C26.206 4.5 26.4298 4.27614 26.4298 4C26.4298 3.72386 26.206 3.5 25.9298 3.5V4.5ZM27.9649 3.5C27.6888 3.5 27.4649 3.72386 27.4649 4C27.4649 4.27614 27.6888 4.5 27.9649 4.5V3.5ZM28.9825 4.5C29.2586 4.5 29.4825 4.27614 29.4825 4C29.4825 3.72386 29.2586 3.5 28.9825 3.5V4.5ZM31.0175 3.5C30.7414 3.5 30.5175 3.72386 30.5175 4C30.5175 4.27614 30.7414 4.5 31.0175 4.5V3.5ZM32.0351 4.5C32.3112 4.5 32.5351 4.27614 32.5351 4C32.5351 3.72386 32.3112 3.5 32.0351 3.5V4.5ZM34.0702 3.5C33.794 3.5 33.5702 3.72386 33.5702 4C33.5702 4.27614 33.794 4.5 34.0702 4.5V3.5ZM35.0877 4.5C35.3639 4.5 35.5877 4.27614 35.5877 4C35.5877 3.72386 35.3639 3.5 35.0877 3.5V4.5ZM37.1228 3.5C36.8467 3.5 36.6228 3.72386 36.6228 4C36.6228 4.27614 36.8467 4.5 37.1228 4.5V3.5ZM38.1404 4.5C38.4165 4.5 38.6404 4.27614 38.6404 4C38.6404 3.72386 38.4165 3.5 38.1404 3.5V4.5ZM40.1754 3.5C39.8993 3.5 39.6754 3.72386 39.6754 4C39.6754 4.27614 39.8993 4.5 40.1754 4.5V3.5ZM41.193 4.5C41.4691 4.5 41.693 4.27614 41.693 4C41.693 3.72386 41.4691 3.5 41.193 3.5V4.5ZM43.2281 3.5C42.9519 3.5 42.7281 3.72386 42.7281 4C42.7281 4.27614 42.9519 4.5 43.2281 4.5V3.5ZM44.2456 4.5C44.5218 4.5 44.7456 4.27614 44.7456 4C44.7456 3.72386 44.5218 3.5 44.2456 3.5V4.5ZM46.2807 3.5C46.0046 3.5 45.7807 3.72386 45.7807 4C45.7807 4.27614 46.0046 4.5 46.2807 4.5V3.5ZM47.2982 4.5C47.5744 4.5 47.7982 4.27614 47.7982 4C47.7982 3.72386 47.5744 3.5 47.2982 3.5V4.5ZM49.3333 3.5C49.0572 3.5 48.8333 3.72386 48.8333 4C48.8333 4.27614 49.0572 4.5 49.3333 4.5V3.5ZM50.3509 4.5C50.627 4.5 50.8509 4.27614 50.8509 4C50.8509 3.72386 50.627 3.5 50.3509 3.5V4.5ZM52.386 3.5C52.1098 3.5 51.886 3.72386 51.886 4C51.886 4.27614 52.1098 4.5 52.386 4.5V3.5ZM53.4035 4.5C53.6796 4.5 53.9035 4.27614 53.9035 4C53.9035 3.72386 53.6796 3.5 53.4035 3.5V4.5ZM55.4386 3.5C55.1625 3.5 54.9386 3.72386 54.9386 4C54.9386 4.27614 55.1625 4.5 55.4386 4.5V3.5ZM56.4561 4.5C56.7323 4.5 56.9561 4.27614 56.9561 4C56.9561 3.72386 56.7323 3.5 56.4561 3.5V4.5ZM58.4912 3.5C58.2151 3.5 57.9912 3.72386 57.9912 4C57.9912 4.27614 58.2151 4.5 58.4912 4.5V3.5ZM1 4.5H1.50877V3.5H1V4.5ZM3.54386 4.5H4.5614V3.5H3.54386V4.5ZM6.59649 4.5H7.61404V3.5H6.59649V4.5ZM9.64912 4.5H10.6667V3.5H9.64912V4.5ZM12.7018 4.5H13.7193V3.5H12.7018V4.5ZM15.7544 4.5H16.7719V3.5H15.7544V4.5ZM18.807 4.5H19.8246V3.5H18.807V4.5ZM21.8596 4.5H22.8772V3.5H21.8596V4.5ZM24.9123 4.5H25.9298V3.5H24.9123V4.5ZM27.9649 4.5H28.9825V3.5H27.9649V4.5ZM31.0175 4.5H32.0351V3.5H31.0175V4.5ZM34.0702 4.5H35.0877V3.5H34.0702V4.5ZM37.1228 4.5H38.1404V3.5H37.1228V4.5ZM40.1754 4.5H41.193V3.5H40.1754V4.5ZM43.2281 4.5H44.2456V3.5H43.2281V4.5ZM46.2807 4.5H47.2982V3.5H46.2807V4.5ZM49.3333 4.5H50.3509V3.5H49.3333V4.5ZM52.386 4.5H53.4035V3.5H52.386V4.5ZM55.4386 4.5H56.4561V3.5H55.4386V4.5ZM58.4912 4.5H59V3.5H58.4912V4.5Z"
								fill="#191918"
								fillOpacity="0.7"
							/>
							<path
								d="M59 21C59.2761 21 59.5 20.7761 59.5 20.5C59.5 20.2239 59.2761 20 59 20L59 21ZM0.646446 20.1464C0.451183 20.3417 0.451183 20.6583 0.646446 20.8535L3.82843 24.0355C4.02369 24.2308 4.34027 24.2308 4.53553 24.0355C4.7308 23.8403 4.7308 23.5237 4.53553 23.3284L1.70711 20.5L4.53553 17.6716C4.7308 17.4763 4.7308 17.1597 4.53553 16.9645C4.34027 16.7692 4.02369 16.7692 3.82843 16.9645L0.646446 20.1464ZM58.4912 20C58.2151 20 57.9912 20.2239 57.9912 20.5C57.9912 20.7761 58.2151 21 58.4912 21L58.4912 20ZM56.4561 21C56.7323 21 56.9561 20.7761 56.9561 20.5C56.9561 20.2239 56.7323 20 56.4561 20L56.4561 21ZM55.4386 20C55.1625 20 54.9386 20.2239 54.9386 20.5C54.9386 20.7761 55.1625 21 55.4386 21L55.4386 20ZM53.4035 21C53.6797 21 53.9035 20.7761 53.9035 20.5C53.9035 20.2239 53.6797 20 53.4035 20L53.4035 21ZM52.386 20C52.1098 20 51.886 20.2239 51.886 20.5C51.886 20.7761 52.1098 21 52.386 21L52.386 20ZM50.3509 21C50.627 21 50.8509 20.7761 50.8509 20.5C50.8509 20.2239 50.627 20 50.3509 20L50.3509 21ZM49.3333 20C49.0572 20 48.8333 20.2239 48.8333 20.5C48.8333 20.7761 49.0572 21 49.3333 21L49.3333 20ZM47.2982 21C47.5744 21 47.7982 20.7761 47.7982 20.5C47.7982 20.2239 47.5744 20 47.2982 20L47.2982 21ZM46.2807 20C46.0046 20 45.7807 20.2239 45.7807 20.5C45.7807 20.7761 46.0046 21 46.2807 21L46.2807 20ZM44.2456 21C44.5218 21 44.7456 20.7761 44.7456 20.5C44.7456 20.2239 44.5218 20 44.2456 20L44.2456 21ZM43.2281 20C42.9519 20 42.7281 20.2239 42.7281 20.5C42.7281 20.7761 42.9519 21 43.2281 21L43.2281 20ZM41.193 21C41.4691 21 41.693 20.7761 41.693 20.5C41.693 20.2239 41.4691 20 41.193 20L41.193 21ZM40.1754 20C39.8993 20 39.6754 20.2239 39.6754 20.5C39.6754 20.7761 39.8993 21 40.1754 21L40.1754 20ZM38.1404 21C38.4165 21 38.6404 20.7761 38.6404 20.5C38.6404 20.2239 38.4165 20 38.1404 20L38.1404 21ZM37.1228 20C36.8467 20 36.6228 20.2239 36.6228 20.5C36.6228 20.7761 36.8467 21 37.1228 21L37.1228 20ZM35.0877 21C35.3639 21 35.5877 20.7761 35.5877 20.5C35.5877 20.2239 35.3639 20 35.0877 20L35.0877 21ZM34.0702 20C33.794 20 33.5702 20.2239 33.5702 20.5C33.5702 20.7761 33.794 21 34.0702 21L34.0702 20ZM32.0351 21C32.3112 21 32.5351 20.7761 32.5351 20.5C32.5351 20.2239 32.3112 20 32.0351 20L32.0351 21ZM31.0175 20C30.7414 20 30.5175 20.2239 30.5175 20.5C30.5175 20.7761 30.7414 21 31.0175 21L31.0175 20ZM28.9825 21C29.2586 21 29.4825 20.7761 29.4825 20.5C29.4825 20.2239 29.2586 20 28.9825 20L28.9825 21ZM27.9649 20C27.6888 20 27.4649 20.2239 27.4649 20.5C27.4649 20.7761 27.6888 21 27.9649 21L27.9649 20ZM25.9298 21C26.206 21 26.4298 20.7761 26.4298 20.5C26.4298 20.2239 26.206 20 25.9298 20L25.9298 21ZM24.9123 20C24.6361 20 24.4123 20.2239 24.4123 20.5C24.4123 20.7761 24.6361 21 24.9123 21L24.9123 20ZM22.8772 21C23.1533 21 23.3772 20.7761 23.3772 20.5C23.3772 20.2239 23.1533 20 22.8772 20L22.8772 21ZM21.8596 20C21.5835 20 21.3596 20.2239 21.3596 20.5C21.3596 20.7761 21.5835 21 21.8596 21L21.8596 20ZM19.8246 21C20.1007 21 20.3246 20.7761 20.3246 20.5C20.3246 20.2239 20.1007 20 19.8246 20L19.8246 21ZM18.807 20C18.5309 20 18.307 20.2239 18.307 20.5C18.307 20.7761 18.5309 21 18.807 21L18.807 20ZM16.7719 21C17.0481 21 17.2719 20.7761 17.2719 20.5C17.2719 20.2239 17.0481 20 16.7719 20L16.7719 21ZM15.7544 20C15.4782 20 15.2544 20.2239 15.2544 20.5C15.2544 20.7761 15.4782 21 15.7544 21L15.7544 20ZM13.7193 21C13.9954 21 14.2193 20.7761 14.2193 20.5C14.2193 20.2239 13.9954 20 13.7193 20L13.7193 21ZM12.7018 20C12.4256 20 12.2018 20.2239 12.2018 20.5C12.2018 20.7761 12.4256 21 12.7018 21L12.7018 20ZM10.6667 21C10.9428 21 11.1667 20.7761 11.1667 20.5C11.1667 20.2239 10.9428 20 10.6667 20L10.6667 21ZM9.64912 20C9.37298 20 9.14912 20.2239 9.14912 20.5C9.14912 20.7761 9.37298 21 9.64912 21L9.64912 20ZM7.61404 21C7.89018 21 8.11404 20.7761 8.11404 20.5C8.11404 20.2239 7.89018 20 7.61404 20L7.61404 21ZM6.59649 20C6.32035 20 6.09649 20.2239 6.09649 20.5C6.09649 20.7761 6.32035 21 6.59649 21L6.59649 20ZM4.56141 21C4.83755 21 5.06141 20.7761 5.06141 20.5C5.06141 20.2239 4.83755 20 4.56141 20L4.56141 21ZM3.54386 20C3.26772 20 3.04386 20.2239 3.04386 20.5C3.04386 20.7761 3.26772 21 3.54386 21L3.54386 20ZM1.50877 21C1.78492 21 2.00877 20.7761 2.00877 20.5C2.00877 20.2239 1.78492 20 1.50877 20L1.50877 21ZM59 20L58.4912 20L58.4912 21L59 21L59 20ZM56.4561 20L55.4386 20L55.4386 21L56.4561 21L56.4561 20ZM53.4035 20L52.386 20L52.386 21L53.4035 21L53.4035 20ZM50.3509 20L49.3333 20L49.3333 21L50.3509 21L50.3509 20ZM47.2982 20L46.2807 20L46.2807 21L47.2982 21L47.2982 20ZM44.2456 20L43.2281 20L43.2281 21L44.2456 21L44.2456 20ZM41.193 20L40.1754 20L40.1754 21L41.193 21L41.193 20ZM38.1404 20L37.1228 20L37.1228 21L38.1404 21L38.1404 20ZM35.0877 20L34.0702 20L34.0702 21L35.0877 21L35.0877 20ZM32.0351 20L31.0175 20L31.0175 21L32.0351 21L32.0351 20ZM28.9825 20L27.9649 20L27.9649 21L28.9825 21L28.9825 20ZM25.9298 20L24.9123 20L24.9123 21L25.9298 21L25.9298 20ZM22.8772 20L21.8596 20L21.8596 21L22.8772 21L22.8772 20ZM19.8246 20L18.807 20L18.807 21L19.8246 21L19.8246 20ZM16.7719 20L15.7544 20L15.7544 21L16.7719 21L16.7719 20ZM13.7193 20L12.7018 20L12.7018 21L13.7193 21L13.7193 20ZM10.6667 20L9.64912 20L9.64912 21L10.6667 21L10.6667 20ZM7.61404 20L6.59649 20L6.59649 21L7.61404 21L7.61404 20ZM4.56141 20L3.54386 20L3.54386 21L4.56141 21L4.56141 20ZM1.50877 20L1 20L1 21L1.50877 21L1.50877 20Z"
								fill="#191918"
								fillOpacity="0.7"
							/>
						</svg>
					</div>
					<img
						id="flare-logo"
						style={{ width: "90px", height: "53px" }}
						src={flareLogo}
						alt="flare-logo"
					/>
				</div>
				<div className="flex flex-col items-center text-center gap-4 mb-4">
					<h1 className="text-dark text-2xl font-bold w-96">
						Connect your QuickBooks Online to get started
					</h1>
					<p className="text-xs w-96">
						Flare conveniently uses your QuickBooks data so that you
						can continue to work in your tools while providing
						importing information to your teams.
					</p>
				</div>
				<button
					className="mx-auto w-52 py-3 text-white bg-flare-red rounded"
					onClick={handleClick}
					disabled={authenticating}
				>
					{authenticating ? "Connecting..." : "Connect"}
				</button>
				{/* Footer */}
				<hr className="border-dark/5 mt-10 " />
			</div>
		</div>
	);
}
